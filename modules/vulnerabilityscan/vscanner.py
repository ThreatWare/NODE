#!/usr/bin/python3
import os,sys,subprocess,json,uuid 
sys.path.appent('../../../')

#ThreatWare Module: Vulnerability Scan
#
#Decription: uses Nmap to scan a machine for vulnerabilities.
#

#Load configuration data
config = loadConfig() 

#Since this script runs asynchronously it's possible to have more than one scan running at once
#So we write our temporary result file to a filename that is guaranteed to be unique.
temp_filename = str(uuid.uuid4())

#Effectively tihs runs
#nmap -Pn --script vuln -oX - 172.16.1.213 > vscanoutput2
subprocess.run(["nmap","-Pn","--script",config['script'],"-oX",temp_filename,config['address']])

#Find a logfile ID that is unused
log_count = 1
log_filename = "output_%s.log"%log_count
while os.path.exists(log_filename):
	log_count += 1
	log_filename = "output_%s.log"%log_count

#Convert the XML output into HTML and write the results to a log file.
subprocess.run(["xsltproc",temp_filename,"-o",log_filename])

#Delete our temporary file
subprocess.run(["rm",temp_filename])
